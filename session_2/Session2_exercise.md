## Section 2: Diels-Alder reaction in vacuum

To obtain the reaction profile of the reaction in vaccum, we are going to use the [Nundged Elastic Band (NEB)](https://theory.cm.utexas.edu/henkelman/pubs/jonsson98_385.pdf) to estimate the energy profile of the Diels Alder reaction. 

We are going to use the resulting structures from the previous section as guesses for the reaction path. Since the structures were optimised using the semi-empirical PM3 method we will also optimise the BAND using PM3. 

You will find the input file here: **GMX_DAA/section2/CP2K/inp.NEB_pm3**

**Highlighted regions of inp.NED_PM3**

We have to set up calculation type as `BAND` in the `&GLOBAL` section:

```
&GLOBAL
  PROJECT DAA_NEB
  RUN_TYPE BAND          ! Band method
  PRINT_LEVEL MEDIUM
&END GLOBAL
```

We use a similar `&FORCE_EVAL` section of the input file because we want to maintain the same QM theory level.
However, we define the section `&BAND` within the `&MOTION` section which will contain parameters relavent for the NEB. 

- `  BAND_TYPE CI-NEB`
- `  NUMBER_OF_REPLICA` 25
- `  K_SPRING` 0.05
- `  &REPLICA` subsection. Here we list the previous optimised structures as initial guesses for NEB.


```
&MOTION
  &BAND                    ! BAND run
    NPROC_REP 12           ! Number of processes to use per replica
    BAND_TYPE CI-NEB       ! Type of BAND calculation - Climbing Image NEB
    NUMBER_OF_REPLICA 25   ! Number of Replica to use in the BAND
    K_SPRING 0.05          ! Spring constant for the band
    
    &CONVERGENCE_CONTROL.  ! control the convergence criteria for BAND
      MAX_FORCE 0.0010
      RMS_FORCE 0.0050
    &END
    
    ROTATE_FRAMES TRUE.    ! Compute at each BAND step the RMSD and rotate the frames in order to minimize it
    ALIGN_FRAMES TRUE      ! Alignment of the frames at the beginning of a BAND calculation
    
    &CI_NEB                ! CI-NEB type calculation only.
      NSTEPS_IT 5          ! Number of Improved Tangent steps before switching on CI algorithm
    &END
    
    &OPTIMIZE_BAND         ! optimization method for the band 
      OPT_TYPE DIIS        ! DIIS based optimization procedure for BAND
      OPTIMIZE_END_POINTS FALSE
      &DIIS
        MAX_STEPS 400      ! The number of steps to run the NEB
      &END
    &END


    &REPLICA               ! Coordinates of the replica
      COORD_FILE_NAME ./DA.R-pos-1.xyz
    &END
    &REPLICA
      COORD_FILE_NAME ./DA.TS-pos-1.xyz
    &END
    &REPLICA
      COORD_FILE_NAME ./DA.P-pos-1.xyz
    &END
  &END BAND

&END MOTION
```

> **TIP**: The order of the atoms in the xyz files MUST be the same in all the structures. 

> **TIP**: In a production run you would not supply MAX_STEPS and instead run until fully converged.

- Note the reactant, product and transition state coordinates which are listed under `&REPLICA` in order. 
- In the output the reactant will be replica no. 1, and the product will be replica no. N (where N is the `NUMBER_OF_REPLICA`), i.e. the end points. 
- During the NEB the coordinates of the end points will not change, but the forces on them will be calculated.
- The transition state in this case will form the starting coordinates for replica no. 13 (the central replica).
- The starting coordinates for other replicas are generated by linear interpolation between the replicas you have supplied.
- You must supply at least the end points (the reactant and product), by supplying the TS will help guide the NEB.

**Running the NEB calculation**

Submit the following jobscipt to run the calculation.

```
qsub -q R7306745 sub-neb.pbs
```

> **TIP**: The NUMBER_OF_REPLICA and NPROC_REP in the input should ideally multiply to give the number of processes used in the job script.


**Understanding the output**


As well as the standard CP2K output in output.neb a series of outputs are generated for each replica in the band. These include:

- ``DAA_NEB-BANDXX.out`` - The geometry optimisation output for each replica.
- ``DAA_NEB-pos-Replica_nr_XX-1.xyz`` - The optimisation trajectory for each replica.
- ``DAA_NEB-r-XX.out`` - The starting point for the geometry optimisation.

By taking the final trajectory printed in each trajectory 
file  you can create an xyz file which will allow you to visualise the optimised transition trajectory.
This can be done by running the following:

```
$  for file in *-1.xyz; do tail -n 26 $file >> DAA-movie.xyz ; done
```
You may then view this with you chosen xyz viewer e.g. vmd:

```
$ module load vmd
$ vmd DAA-movie.xyz
```
The energy profile can be obtained from the final energies of each of the replicas.
This is printed at the end of output.neb for all replicas, and also in ``DAA_NEB-BANDXX.out`` for the individual replicas.

```
$ grep 'Total Energy' output.neb | tail -n 25
```

As before the energy is given in Hartrees, but you can convert it into different units.

If we write the energy profile with respect to the energy of the reactant, the following energy profile is obtained:



Replica  |  Energy / Har. | Energy / kcalmol-1
------------ | ------------- | ----------
1 (R)	|	0	|	0
2	|	3.2339E-05	|	0.020292723
3	|	9.8727E-05	|	0.061951192
4	|	0.000181315	|	0.113775162
5	|	0.000279205	|	0.175201137
6	|	0.000392973	|	0.246590558
7	|	0.00052199	|	0.327548725
8	|	0.000664901	|	0.417225377
9	|	0.000820476	|	0.51484869
10	|	0.000987411	|	0.619600402
11	|	0.00116482	|	0.73092455
12	|	0.00135152	|	0.8480788
13	|	0.001545207	|	0.969617392
14	|	0.001743655	|	1.094143512
15	|	0.001956858	|	1.227928395
16	|	0.002283948	|	1.43317737
17	|	0.003321503	|	2.084243132
18	|	0.006800094	|	4.267058985
19	|	0.014342856	|	9.00014214
20	|	0.030603023	|	19.20339693
21	|	0.076193096	|	47.81116774
22	|	-0.010935051	|	-6.861744503
23	|	-0.013642414	|	-8.560614785
24	|	-0.013725834	|	-8.612960835
25 (P)	|	-0.013857793	|	-8.695765107


The replica with the highest energy (no. 21) corresponds to the transition state.
The energy of this state minus the energy of the reactant gives us the energy barrier
required for this reaction.

This energy barrier is the same as that calculated with the Dimer method in the previous execise.
Using NEB also gives the energy profile of the minimum energy pathway between the
reactant and product which passes through the transition state. If you like you
can plot this.

Using more replica requires more compute resources as we assign a fixed number of cores per replica.
However the a larger number of replica gives a more accurate result and usually the NEB
converges faster. In our case for 25 replica the calculation took x steps.




<br/><br/>

---